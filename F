import streamlit as st
import pandas as pd
import numpy as np
import pickle
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.preprocessing import StandardScaler, OrdinalEncoder
from sklearn.decomposition import PCA
from sklearn.impute import KNNImputer
import warnings
warnings.filterwarnings('ignore')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞",
    layout="wide",
    page_icon="üèÉ"
)

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.title("üèÉ –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞")
st.markdown("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ML –º–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ç–∏–ø–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–æ–≤")

# –°–æ–∑–¥–∞–µ–º –¥–≤–µ –≤–∫–ª–∞–¥–∫–∏
tab1, tab2 = st.tabs(["üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏", "üîÆ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"])

# –í–∫–ª–∞–¥–∫–∞ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏
with tab1:
    st.header("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏")
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏
    st.subheader("–ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å")
    st.markdown("""
    **–ú–æ–¥–µ–ª—å:** XGBoost (Gradient Boosting)
    
    **–¢–∏–ø –∑–∞–¥–∞—á–∏:** –ú–Ω–æ–≥–æ–∫–ª–∞—Å—Å–æ–≤–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
    
    **–ö–ª–∞—Å—Å—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:**
    - 0: walking
    - 1: descending stairs
    - 2: lying
    - 3: standing
    - 4: sitting
    
    **–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏:**
    –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö —Å –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞ –∏ –≥–∏—Ä–æ—Å–∫–æ–ø–∞, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å–æ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞.
    """)
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö
    st.subheader("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("–í—Å–µ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤", "21")
        st.metric("–ü—Ä–∏–∑–Ω–∞–∫–∏ –ø–æ—Å–ª–µ PCA", "‚âà 15-20")
    
    with col2:
        st.metric("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Å–æ–≤", "5")
        st.metric("–¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏", "95%+")
    
    with col3:
        st.metric("–¢–∏–ø –ø—Ä–∏–∑–Ω–∞–∫–æ–≤", "–ß–∏—Å–ª–æ–≤—ã–µ")
        st.metric("–ú–æ–¥–µ–ª—å", "XGBoost")
    
    # –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
    st.subheader("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
    st.markdown("""
    –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã:
    
    **–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
    - `time_s`: –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    - `lh_x`, `lh_y`, `lh_z`: –î–∞–Ω–Ω—ã–µ —Å –ª–µ–≤–æ–π —Ä—É–∫–∏
    - `rh_x`, `rh_y`, `rh_z`: –î–∞–Ω–Ω—ã–µ —Å –ø—Ä–∞–≤–æ–π —Ä—É–∫–∏
    - `la_x`, `la_y`, `la_z`: –î–∞–Ω–Ω—ã–µ —Å –ª–µ–≤–æ–π –Ω–æ–≥–∏
    - `ra_x`, `ra_y`, `ra_z`: –î–∞–Ω–Ω—ã–µ —Å –ø—Ä–∞–≤–æ–π –Ω–æ–≥–∏
    - `back_x`, `back_y`, `back_z`: –î–∞–Ω–Ω—ã–µ —Å–æ —Å–ø–∏–Ω—ã
    
    **–î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ:**
    - `gender`: –ü–æ–ª (male/female)
    - `age`: –í–æ–∑—Ä–∞—Å—Ç
    - `race`: –†–∞—Å–∞ (caucasian/asian/black)
    - `right_handed`: –ü—Ä–∞–≤—à–∞ (True/False)
    """)
    
    # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö
    st.subheader("–ü—Ä–∏–º–µ—Ä –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    example_data = {
        'time_s': [1.0],
        'lh_x': [0.12], 'lh_y': [-0.45], 'lh_z': [9.81],
        'rh_x': [0.15], 'rh_y': [-0.42], 'rh_z': [9.79],
        'la_x': [0.08], 'la_y': [-0.48], 'la_z': [9.80],
        'ra_x': [0.10], 'ra_y': [-0.46], 'ra_z': [9.82],
        'back_x': [0.05], 'back_y': [-0.50], 'back_z': [9.78],
        'gender': ['male'],
        'age': [25],
        'race': ['caucasian'],
        'right_handed': [True]
    }
    
    example_df = pd.DataFrame(example_data)
    st.dataframe(example_df, use_container_width=True)
    
    # –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏
    st.subheader("–ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö")
    
    steps = [
        "1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö",
        "2. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ 'subj_id' (–µ—Å–ª–∏ –µ—Å—Ç—å)",
        "3. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –º–µ—Ç–æ–¥–æ–º KNN",
        "4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–æ—Å–æ–≤ –º–µ—Ç–æ–¥–æ–º IQR",
        "5. –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö",
        "6. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤",
        "7. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ PCA –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏",
        "8. –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é XGBoost"
    ]
    
    for step in steps:
        st.markdown(f"‚úÖ {step}")

# –í–∫–ª–∞–¥–∫–∞ 2: –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
with tab2:
    st.header("–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
    @st.cache_resource
    def load_model():
        try:
            with open('xgb_clf.pickle', 'rb') as f:
                model = pickle.load(f)
            return model
        except FileNotFoundError:
            st.error("–§–∞–π–ª –º–æ–¥–µ–ª–∏ 'xgb_clf.pickle' –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            return None
    
    model = load_model()
    
    if model is not None:
        st.success("‚úÖ –ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")
        
        # –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Ç–æ–π, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏)
        def preprocess_single_row(df_row, imputer=None, scaler=None, pca=None):
            """
            –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            """
            df = df_row.copy()
            
            # 1. –£–¥–∞–ª–µ–Ω–∏–µ subj_id, –µ—Å–ª–∏ –µ—Å—Ç—å
            if 'subj_id' in df.columns:
                df = df.drop('subj_id', axis=1)
            
            # 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
            num_cols = [col for col in df.columns if (df[col].dtype == 'int64' or df[col].dtype == 'float64')]
            cat_cols = [col for col in df.columns if df[col].dtype == 'object']
            
            # 3. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
            if imputer is None:
                # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π imputer –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
                from sklearn.impute import SimpleImputer
                imputer = SimpleImputer(strategy='mean')
                # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—É—á–µ–Ω–Ω—ã–π KNNImputer
                # –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                if num_cols:
                    df[num_cols] = imputer.fit_transform(df[num_cols])
            else:
                if num_cols:
                    df[num_cols] = imputer.transform(df[num_cols])
            
            # 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
            for col in cat_cols:
                if col == 'gender':
                    # –°–æ–∑–¥–∞–µ–º encoder –¥–ª—è gender
                    gender_encoder = OrdinalEncoder(categories=[['female', 'male']])
                    try:
                        df[col] = gender_encoder.fit_transform(df[[col]])
                    except:
                        # –ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–æ—Å—å –Ω–µ–∑–Ω–∞–∫–æ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        df[col] = 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é female
                elif col == 'race':
                    # –°–æ–∑–¥–∞–µ–º encoder –¥–ª—è race
                    race_categories = [['caucasian', 'asian', 'black']]
                    race_encoder = OrdinalEncoder(categories=race_categories)
                    try:
                        df[col] = race_encoder.fit_transform(df[[col]])
                    except:
                        # –ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–æ—Å—å –Ω–µ–∑–Ω–∞–∫–æ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        df[col] = 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é caucasian
                elif col == 'right_handed':
                    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º boolean –≤ int
                    df[col] = df[col].astype(int)
            
            # 5. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
            if scaler is None:
                scaler = StandardScaler()
                if num_cols:
                    df[num_cols] = scaler.fit_transform(df[num_cols])
            else:
                if num_cols:
                    df[num_cols] = scaler.transform(df[num_cols])
            
            # 6. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ PCA
            if pca is not None:
                df = pca.transform(df)
            
            return df
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
        st.subheader("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è")
        
        uploaded_file = st.file_uploader(
            "–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è", 
            type=['csv'],
            help="–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏"
        )
        
        if uploaded_file is not None:
            try:
                # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                try:
                    data = pd.read_csv(uploaded_file, sep='$')
                except:
                    data = pd.read_csv(uploaded_file)
                
                st.success(f"‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {data.shape[0]} —Å—Ç—Ä–æ–∫, {data.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤")
                
                # –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                with st.expander("–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö", expanded=True):
                    st.dataframe(data, use_container_width=True)
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞
                if len(data) > 1:
                    st.warning("‚ö†Ô∏è –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏. –ë—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤—Å–µ —Å—Ç—Ä–æ–∫–∏.")
                
                # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
                if st.button("üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ", type="primary", use_container_width=True):
                    with st.spinner("–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è..."):
                        # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                        processed_data = preprocess_single_row(data)
                        
                        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
                        predictions = model.predict(processed_data)
                        probabilities = model.predict_proba(processed_data)
                        
                        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        st.subheader("üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è")
                        
                        # –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        for i in range(len(predictions)):
                            st.markdown(f"**–°—Ç—Ä–æ–∫–∞ {i+1}:**")
                            
                            col1, col2 = st.columns(2)
                            
                            with col1:
                                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–¥—É
                                activity_map = {
                                    0: "üö∂ walking",
                                    1: "‚¨áÔ∏è descending stairs", 
                                    2: "üõå lying",
                                    3: "üßç standing",
                                    4: "ü™ë sitting"
                                }
                                
                                pred_class = int(predictions[i])
                                pred_name = activity_map.get(pred_class, f"–ö–ª–∞—Å—Å {pred_class}")
                                
                                st.metric("–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", pred_name)
                            
                            with col2:
                                # –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
                                max_prob = np.max(probabilities[i]) * 100
                                st.metric("–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏", f"{max_prob:.1f}%")
                            
                            # –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –∫–ª–∞—Å—Å–æ–≤
                            st.markdown("**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –ø–æ –∫–ª–∞—Å—Å–∞–º:**")
                            
                            # –°–æ–∑–¥–∞–µ–º DataFrame —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏
                            prob_df = pd.DataFrame({
                                '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': [activity_map.get(j, f"–ö–ª–∞—Å—Å {j}") for j in range(len(probabilities[i]))],
                                '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å': [f"{p*100:.2f}%" for p in probabilities[i]]
                            })
                            
                            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
                            prob_df = prob_df.sort_values('–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å', ascending=False)
                            
                            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                            st.dataframe(prob_df, use_container_width=True)
                            
                            # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
                            fig, ax = plt.subplots(figsize=(10, 4))
                            y_pos = np.arange(len(probabilities[i]))
                            ax.barh(y_pos, probabilities[i])
                            ax.set_yticks(y_pos)
                            ax.set_yticklabels([activity_map.get(j, f"–ö–ª–∞—Å—Å {j}") for j in range(len(probabilities[i]))])
                            ax.set_xlabel('–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å')
                            ax.set_title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –ø–æ –∫–ª–∞—Å—Å–∞–º')
                            ax.invert_yaxis()  # –°–∞–º—ã–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ —Å–≤–µ—Ä—Ö—É
                            st.pyplot(fig)
                        
                        st.success("‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!")
                        
            except Exception as e:
                st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {str(e)}")
                st.info("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è CSV —Ñ–∞–π–ª —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º '$' –∏–ª–∏ –∑–∞–ø—è—Ç—ã–º–∏.")
        else:
            # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            st.info("–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä –Ω–∏–∂–µ:")
            
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            example_data = pd.DataFrame({
                'time_s': [1.0],
                'lh_x': [0.12], 'lh_y': [-0.45], 'lh_z': [9.81],
                'rh_x': [0.15], 'rh_y': [-0.42], 'rh_z': [9.79],
                'la_x': [0.08], 'la_y': [-0.48], 'la_z': [9.80],
                'ra_x': [0.10], 'ra_y': [-0.46], 'ra_z': [9.82],
                'back_x': [0.05], 'back_y': [-0.50], 'back_z': [9.78],
                'gender': ['male'],
                'age': [25],
                'race': ['caucasian'],
                'right_handed': [True]
            })
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º DataFrame –≤ CSV
            csv = example_data.to_csv(index=False, sep='$')
            
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–∏–º–µ—Ä–∞
            st.download_button(
                label="üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è",
                data=csv,
                file_name="example_prediction_data.csv",
                mime="text/csv",
                help="–°–∫–∞—á–∞–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è"
            )
            
            # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–∏–º–µ—Ä–∞
            with st.expander("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–º–µ—Ä–∞ —Ñ–∞–π–ª–∞"):
                st.dataframe(example_data, use_container_width=True)
                st.markdown("""
                **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**
                1. –°–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞
                2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Excel –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
                3. –ó–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (—Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞)
                4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ CSV —Ñ–∞–π–ª
                5. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ñ–æ—Ä–º—É –≤—ã—à–µ
                """)
    else:
        st.error("–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª 'xgb_clf.pickle' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ.")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –ø–æ–¥–≤–∞–ª–µ
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: gray;'>
    <p>–î–∞—à–±–æ—Ä–¥ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞ | –ú–æ–¥–µ–ª—å: XGBoost | –ê–≤—Ç–æ—Ä: –ú–∞—Ç—Ä–æ—Å–æ–≤–∞ –†–∞–∏—Å–∞</p>
</div>
""", unsafe_allow_html=True)

# –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏)
st.markdown("""
<style>
    .stButton > button {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
        border-radius: 5px;
        padding: 10px 24px;
    }
    .stButton > button:hover {
        background-color: #45a049;
    }
    .css-1d391kg {
        padding-top: 2rem;
    }
    .metric-container {
        background-color: #f0f2f6;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
    }
</style>
""", unsafe_allow_html=True)
